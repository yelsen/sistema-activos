<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<body>
    <div th:fragment="modalCrear" class="modal fade" id="modalCrearResponsable" tabindex="-1"
        aria-labelledby="modalCrearResponsableLabel" aria-hidden="true" 
        th:attr="data-search-url=@{/personas/buscar-responsable}">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-primary text-white">
                    <div class="d-flex align-items-center gap-3">
                        <i class="ti ti-user-check fs-2"></i>
                        <div>
                            <h5 class="mb-0 text-white">Asignar Responsable</h5>
                            <p class="fs-10 mb-0 text-white-50">Asigna una persona como responsable de un departamento.</p>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <form th:action="@{/responsables}" th:object="${responsable}" method="post" id="formCrearResponsable"
                    class="needs-validation" novalidate>
                    <div class="modal-body p-4">
                        <div class="row g-3">
                            <!-- Información Personal -->
                            <div class="col-12">
                                <h6 class="text-primary border-bottom pb-2 fw-semibold">
                                    <i class="ti ti-user me-2"></i>Información Personal
                                </h6>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <label for="dniPersona" class="form-label">DNI <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="ti ti-id"></i></span>
                                    <input type="text" class="form-control" id="dniPersona" th:field="*{dniPersona}"
                                           placeholder="Ingrese DNI de 8 dígitos..." required pattern="\d{8}" maxlength="8">
                                </div>
                                <small class="text-muted">El sistema buscará automáticamente</small>
                            </div>

                            <!-- Panel de feedback -->
                            <div class="col-12 mb-3">
                                <div id="persona-feedback" aria-live="polite"></div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="nombres" class="form-label">Nombres</label>
                                <input type="text" class="form-control" id="nombres" th:field="*{nombres}" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="apellidos" class="form-label">Apellidos</label>
                                <input type="text" class="form-control" id="apellidos" th:field="*{apellidos}" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" th:field="*{email}" readonly>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="text" class="form-control" id="telefono" th:field="*{telefono}" readonly>
                            </div>

                            <!-- Información del Responsable -->
                            <div class="col-12 mt-4">
                                <h6 class="text-primary border-bottom pb-2 fw-semibold">
                                    <i class="ti ti-briefcase me-2"></i>Información del Cargo
                                </h6>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="idDepartamento" class="form-label">Departamento <span class="text-danger">*</span></label>
                                <select id="idDepartamento" th:field="*{idDepartamento}" class="form-select" data-choices required>
                                    <option value="">Seleccione un departamento</option>
                                    <option th:each="dep : ${departamentos}" th:value="${dep.id}" th:text="${dep.nombre}"></option>
                                </select>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="cargo" class="form-label">Cargo <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="cargo" th:field="*{cargo}" 
                                       placeholder="Ej: Jefe de Departamento" required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="fechaInicio" class="form-label">Fecha de Inicio <span class="text-danger">*</span></label>
                                <input type="date" class="form-control" id="fechaInicio" th:field="*{fechaInicio}" required>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="fechaFin" class="form-label">Fecha de Fin</label>
                                <input type="date" class="form-control" id="fechaFin" th:field="*{fechaFin}">
                                <small class="text-muted">Dejar en blanco si es indefinido</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-ghost-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="btnGuardarResponsable">
                            <i class="ti ti-device-floppy me-1"></i>Asignar Responsable
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Script específico para responsables -->
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const modalEl = document.getElementById('modalCrearResponsable');
            if (!modalEl) return;

            const form = document.getElementById('formCrearResponsable');
            const dniInput = document.getElementById('dniPersona');
            const feedbackPanel = document.getElementById('persona-feedback');
            const saveButton = document.getElementById('btnGuardarResponsable');
            const searchUrl = modalEl.dataset.searchUrl || '/personas/buscar-responsable';
            
            let debounceTimer;
            let ultimoDniBuscado = '';

            const personalFields = {
                nombres: document.getElementById('nombres'),
                apellidos: document.getElementById('apellidos'),
                email: document.getElementById('email'),
                telefono: document.getElementById('telefono')
            };

            function renderFeedbackAlert(container, type, title, message) {
                const iconMap = {
                    'success': 'ti-circle-check',
                    'danger': 'ti-alert-circle',
                    'warning': 'ti-alert-triangle',
                    'info': 'ti-info-circle'
                };

                const colorMap = {
                    'success': 'success',
                    'danger': 'danger',
                    'warning': 'warning',
                    'info': 'info'
                };

                const icon = iconMap[type] || 'ti-info-circle';
                const color = colorMap[type] || 'info';

                container.innerHTML = `
                    <div class="alert alert-${color} alert-dismissible fade show d-flex align-items-start" role="alert">
                        <i class="ti ${icon} fs-4 me-2 flex-shrink-0"></i>
                        <div class="flex-grow-1">
                            <strong>${title}</strong>
                            <p class="mb-0 mt-1">${message}</p>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
            }

            function resetFormState() {
                form.reset();
                ultimoDniBuscado = '';
                saveButton.disabled = false;
                feedbackPanel.innerHTML = '';
            }

            async function searchByDni(dni) {
                if (!/^\d{8}$/.test(dni)) {
                    if (dni.length > 0) {
                        renderFeedbackAlert(feedbackPanel, 'info', 'DNI Incompleto', 
                            'Ingrese los 8 dígitos del DNI.');
                    } else {
                        feedbackPanel.innerHTML = '';
                    }
                    return;
                }

                if (dni === ultimoDniBuscado) return;
                ultimoDniBuscado = dni;

                renderFeedbackAlert(feedbackPanel, 'info', 'Buscando...', 
                    `Consultando información del DNI ${dni}...`);

                try {
                    const response = await fetch(`${searchUrl}?dni=${encodeURIComponent(dni)}`);

                    if (response.ok) {
                        const data = await response.json();
                        
                        // Autocompletar campos
                        Object.keys(personalFields).forEach(fieldName => {
                            const field = personalFields[fieldName];
                            if (field && data[fieldName]) {
                                field.value = data[fieldName];
                            }
                        });
                        
                        // Verificar si ya es responsable
                        if (data.esResponsable) {
                            renderFeedbackAlert(feedbackPanel, 'warning', 'Ya es Responsable', 
                                `Esta persona ya es responsable del departamento: ${data.departamentoActual}. ¿Desea reasignarlo?`);
                            saveButton.disabled = false;
                        } else {
                            renderFeedbackAlert(feedbackPanel, 'success', 'Persona Encontrada', 
                                'Complete la información del cargo y departamento.');
                            saveButton.disabled = false;
                        }

                    } else if (response.status === 404) {
                        renderFeedbackAlert(feedbackPanel, 'danger', 'Persona No Encontrada', 
                            'No existe una persona registrada con este DNI. Primero debe registrarla en el módulo de Personas.');
                        Object.values(personalFields).forEach(f => { if(f) f.value = ''; });
                        saveButton.disabled = true;
                    } else {
                        throw new Error(`Error ${response.status}`);
                    }
                } catch (error) {
                    renderFeedbackAlert(feedbackPanel, 'danger', 'Error de Conexión', 
                        'No se pudo realizar la búsqueda.');
                    console.error("Error:", error);
                }
            }

            dniInput.addEventListener('input', (e) => {
                const dni = e.target.value.trim();
                clearTimeout(debounceTimer);
                
                if (dni.length < 8) {
                    ultimoDniBuscado = '';
                    if (dni.length === 0) {
                        feedbackPanel.innerHTML = '';
                    }
                }
                
                if (dni.length === 8) {
                    debounceTimer = setTimeout(() => searchByDni(dni), 300);
                }
            });

            modalEl.addEventListener('shown.bs.modal', () => {
                resetFormState();
                dniInput.focus();
                renderFeedbackAlert(feedbackPanel, 'info', 'Búsqueda de Persona', 
                    'Ingrese un DNI de 8 dígitos.');
            });
        });
    </script>
</body>

</html>