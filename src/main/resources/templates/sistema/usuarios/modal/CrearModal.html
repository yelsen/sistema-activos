<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">

<body>
    <style>
        /* Espaciado más compacto en el modal de crear usuario */
        #modalCrearUsuario .modal-body {
            padding-bottom: 0.75rem;
        }

        #modalCrearUsuario .col-md-6.mb-3 {
            margin-bottom: .5rem !important;
        }

        #modalCrearUsuario .row.mb-3 {
            margin-bottom: .75rem !important;
        }

        #modalCrearUsuario #persona-feedback .card {
            border-width: 1px;
        }
    </style>
    <div th:fragment="modalCrear" class="modal fade" id="modalCrearUsuario" tabindex="-1"
        aria-labelledby="modalCrearUsuarioLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg">
                <div class="modal-header bg-azulunasam text-white position-relative modal-shape-header">
                    <div class="d-flex align-items-center gap-3 position-relative">
                        <i class="ti ti-user-plus fs-2"></i>
                        <div>
                            <h5 class="mb-0 text-white">Crear Nuevo Usuario</h5>
                            <p class="fs-10 mb-0 text-white-50">Registra un nuevo usuario y asígnale un rol.</p>
                        </div>
                    </div>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>

                <form th:action="@{/seguridad/usuarios}" th:object="${usuario}" method="post" id="formCrearUsuario"
                    class="needs-validation" novalidate autocomplete="off">
                    <div class="modal-body">
                        <!-- Sección de Persona -->
                        <div class="col-12 mb-3">
                            <h6 class="text-primary border-bottom pb-2 fw-semibold">
                                <i class="ti ti-user me-2"></i>Información Personal
                            </h6>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dni" class="form-label">
                                    DNI <span class="text-danger">*</span>
                                </label>
                                <div class="input-group has-validation">
                                    <span class="input-group-text text-bg-secondary">
                                        <i class="ti ti-id"></i>
                                    </span>
                                    <input type="text" class="form-control" id="dni" th:field="*{dniPersona}"
                                        placeholder="Ingrese DNI (8 dígitos)" maxlength="8" pattern="[0-9]{8}"
                                        inputmode="numeric" autocomplete="off" required>
                                    <div class="invalid-feedback">
                                        Por favor ingrese un DNI válido (8 dígitos numéricos).
                                    </div>
                                </div>
                            </div>

                            <!-- Panel de feedback justo debajo del DNI -->
                            <div class="col-12 mb-2" id="persona-feedback" aria-live="polite"></div>

                            <div class="col-md-6 mb-3">
                                <label for="nombres" class="form-label">
                                    Nombres <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="nombres" th:field="*{nombres}"
                                    autocomplete="off" maxlength="100" required pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+"
                                    placeholder="Ingrese nombres">
                                <div class="invalid-feedback">Ingrese nombres válidos (solo letras, mínimo 2 caracteres)
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="apellidos" class="form-label">
                                    Apellidos <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="apellidos" th:field="*{apellidos}"
                                    autocomplete="off" maxlength="100" required pattern="[A-Za-zÁÉÍÓÚáéíóúÑñ\s]+"
                                    placeholder="Ingrese apellidos">
                                <div class="invalid-feedback">Ingrese apellidos válidos (solo letras, mínimo 2
                                    caracteres)</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="email" class="form-label">
                                    Email <span class="text-danger">*</span>
                                </label>
                                <input type="email" class="form-control" id="email" th:field="*{email}"
                                    autocomplete="off" maxlength="100" required placeholder="ejemplo@correo.com">
                                <div class="invalid-feedback">Ingrese un email válido</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="telefono" class="form-label">Teléfono</label>
                                <input type="text" class="form-control" id="telefono" th:field="*{telefono}"
                                    maxlength="20" autocomplete="off" placeholder="Ingrese teléfono (opcional)"
                                    pattern="[\+]?[0-9\s\-\(\)\.]+">
                                <div class="invalid-feedback">Ingrese un teléfono válido</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="direccion" class="form-label">Dirección</label>
                                <input type="text" class="form-control" id="direccion" th:field="*{direccion}"
                                    maxlength="200" autocomplete="off" minlength="5"
                                    placeholder="Ingrese dirección (opcional)">
                                <div class="invalid-feedback">Ingrese una dirección válida (mínimo 5 caracteres)
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="genero" class="form-label">
                                    Género <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="genero" th:field="*{genero}" data-choices
                                    placeholder="Seleccione un género" required>
                                    <option value="">Seleccione un género</option>
                                    <option th:each="g : ${generos}" th:value="${g.name()}"
                                        th:text="${#strings.capitalize(g.name().toLowerCase())}"></option>
                                </select>
                                <div class="invalid-feedback">Seleccione un género</div>
                            </div>
                        </div>

                        <!-- Panel de feedback movido debajo del DNI dentro de la fila -->

                        <!-- Sección de Cuenta -->
                        <div class="col-12 mb-3">
                            <h6 class="text-primary border-bottom pb-2 fw-semibold">
                                <i class="ti ti-key me-2"></i>Credenciales de Acceso
                            </h6>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="usuario" class="form-label">
                                    Usuario <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control" id="usuario" th:field="*{usuario}"
                                    autocomplete="off" maxlength="50" required minlength="4" pattern="[A-Za-z0-9._\-]+"
                                    placeholder="Mínimo 4 caracteres">
                                <div class="invalid-feedback">Usuario debe tener al menos 4 caracteres (letras,
                                    números,
                                    . _ -)</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="rol" class="form-label">
                                    Rol <span class="text-danger">*</span>
                                </label>
                                <select id="rol" th:field="*{idRol}" class="form-select" data-choices
                                    placeholder="Seleccione un rol" required>
                                    <option value="">Seleccione un rol</option>
                                    <option th:each="rol : ${roles}" th:value="${rol.idRol}" th:text="${rol.nombreRol}">
                                    </option>
                                </select>
                                <div class="invalid-feedback">Seleccione un rol</div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="contrasena" class="form-label">
                                    Contraseña <span class="text-danger">*</span>
                                </label>
                                <input type="password" class="form-control" id="contrasena" th:field="*{contrasena}"
                                    autocomplete="new-password" placeholder="Mínimo 8 caracteres" required
                                    data-no-inline-validation="true">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="confirmarContrasena" class="form-label">
                                    Confirmar Contraseña <span class="text-danger">*</span>
                                </label>
                                <input type="password" class="form-control" id="confirmarContrasena"
                                    name="confirmarContrasena" autocomplete="new-password"
                                    placeholder="Repita la contraseña" required data-no-inline-validation="true">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-ghost-secondary"
                                data-bs-dismiss="modal">Cancelar</button>
                            <button type="submit" class="btn btn-primary" id="btnGuardar">
                                <i class="ti ti-device-floppy me-1"></i>Guardar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script th:inline="javascript">
        (function () {
            function initCrearUsuarioModal() {
                const modalCrearEl = document.getElementById('modalCrearUsuario');
                if (!modalCrearEl) return;

                if (typeof window.setupRealTimeValidation === 'function') {
                    window.setupRealTimeValidation('formCrearUsuario');
                }

                // ---- Auto-búsqueda por DNI y feedback ----
                const dniInput = document.getElementById('dni');
                const nombresInput = document.getElementById('nombres');
                const apellidosInput = document.getElementById('apellidos');
                const emailInput = document.getElementById('email');
                const telefonoInput = document.getElementById('telefono');
                const direccionInput = document.getElementById('direccion');
                const generoSelect = document.getElementById('genero');
                const btnGuardar = document.getElementById('btnGuardar');
                const feedback = document.getElementById('persona-feedback');

                if (!dniInput || !feedback) return;

                const searchUrl = /*[[@{/api/personas/buscar}]]*/ '/api/personas/buscar';

                function setPersonaFieldsDisabled(disabled) {
                    [nombresInput, apellidosInput, emailInput, telefonoInput, direccionInput, generoSelect]
                        .forEach(el => el.disabled = disabled);
                }

                function clearPersonaFields() {
                    [nombresInput, apellidosInput, emailInput, telefonoInput, direccionInput]
                        .forEach(el => el.value = '');
                    generoSelect.value = '';
                    setPersonaFieldsDisabled(false);
                }

                function showCard(type, title, message) {
                    const colors = {
                        success: { border: 'border-success', bg: 'bg-success-subtle', icon: 'ti ti-check' },
                        warning: { border: 'border-warning', bg: 'bg-warning-subtle', icon: 'ti ti-alert-triangle' },
                        info: { border: 'border-info', bg: 'bg-info-subtle', icon: 'ti ti-info-circle' }
                    };
                    const c = colors[type] || colors.info;
                    feedback.innerHTML = `
                        <div class="card ${c.border}">
                            <div class="card-body ${c.bg} d-flex align-items-start gap-2" role="status" aria-live="polite">
                                <i class="${c.icon} mt-1"></i>
                                <div>
                                    <div class="fw-semibold">${title}</div>
                                    <div class="small">${message}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                async function buscarPersonaPorDni(dni) {
                    if (!dni || dni.length !== 8) return;
                    showCard('info', 'Buscando persona', 'Consultando por DNI ' + dni + '...');
                    try {
                        const resp = await fetch(`${searchUrl}?dni=${encodeURIComponent(dni)}`, {
                            headers: { 'Accept': 'application/json' }
                        });
                        if (resp.ok) {
                            const persona = await resp.json();
                            nombresInput.value = persona.nombres || '';
                            apellidosInput.value = persona.apellidos || '';
                            emailInput.value = persona.email || '';
                            telefonoInput.value = persona.telefono || '';
                            direccionInput.value = persona.direccion || '';
                            generoSelect.value = persona.genero || '';

                            if (persona.tieneUsuario) {
                                setPersonaFieldsDisabled(true);
                                btnGuardar.disabled = true;
                                showCard('warning', 'Persona con usuario', 'Ya tiene usuario asignado. No se puede crear otro.');
                            } else {
                                setPersonaFieldsDisabled(true);
                                btnGuardar.disabled = false;
                                showCard('success', 'Persona encontrada', 'Datos precargados. Complete usuario, rol y contraseña.');
                            }
                        } else if (resp.status === 404) {
                            clearPersonaFields();
                            btnGuardar.disabled = false;
                            showCard('info', 'Persona no encontrada', 'Complete los campos para crear la persona y su usuario.');
                        } else if (resp.status === 403) {
                            clearPersonaFields();
                            btnGuardar.disabled = false;
                            showCard('warning', 'Permiso insuficiente', 'No tienes permisos para consultar personas (USUARIOS_CREAR).');
                        } else {
                            clearPersonaFields();
                            btnGuardar.disabled = false;
                            showCard('warning', 'No se pudo buscar', 'Ocurrió un problema al consultar el DNI.');
                        }
                    } catch (e) {
                        clearPersonaFields();
                        btnGuardar.disabled = false;
                        showCard('warning', 'Error de red', 'No se pudo conectar para buscar el DNI.');
                    }
                }

                // Debounce y binding al abrir el modal
                let debounceId;
                function bindDniListener() {
                    dniInput.addEventListener('input', function () {
                        const value = dniInput.value.trim();
                        clearTimeout(debounceId);
                        debounceId = setTimeout(() => {
                            if (/^\d{8}$/.test(value)) {
                                buscarPersonaPorDni(value);
                            } else {
                                feedback.innerHTML = '';
                                btnGuardar.disabled = false;
                            }
                        }, 200);
                    }, { once: true });

                    // Evalúa si ya hay 8 dígitos al abrir
                    const initial = dniInput.value.trim();
                    if (/^\d{8}$/.test(initial)) buscarPersonaPorDni(initial);
                }

                // Bind inmediato y al mostrar el modal
                bindDniListener();
                modalCrearEl.addEventListener('shown.bs.modal', bindDniListener);
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initCrearUsuarioModal);
            } else {
                initCrearUsuarioModal();
            }
        })();
    </script>
</body>

</html>