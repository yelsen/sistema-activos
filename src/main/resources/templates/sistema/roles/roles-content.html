<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<div th:fragment="content">
    <!-- Header de la página -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-3 h2">Gestión de Roles</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/dashboard}">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="#">Seguridad</a></li>
                <li class="breadcrumb-item active" aria-current="page">Roles</li>
            </ol>
        </nav>
    </div>

    <!-- Contenido principal -->
    <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="card-title mb-0">Listado de Roles</h5>
                <p class="mb-0 text-secondary small">Administra los roles y sus permisos asociados en el sistema.</p>
            </div>
            <div sec:authorize="hasAuthority('ROLES_CREAR')">
                <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalCrearRol">
                    <i class="ti ti-plus me-1"></i> Nuevo Rol
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- Formulario de Búsqueda y Filtro -->
            <form id="filterForm" th:action="@{/seguridad/roles}" method="get" class="row g-3 py-2">
                <div class="col-md-8">
                    <input type="text" class="form-control" placeholder="Buscar rol por nombre..."
                        th:value="${searchQuery}" name="query" onchange="this.form.submit()">
                </div>
                <div class="col-md-4">
                    <select class="form-select" name="estado" onchange="this.form.submit()" data-choices>
                        <option value="">Todos los estados</option>
                        <option value="ACTIVO" th:selected="${estado != null and estado.name() == 'ACTIVO'}">Activo
                        </option>
                        <option value="INACTIVO" th:selected="${estado != null and estado.name() == 'INACTIVO'}">
                            Inactivo</option>
                    </select>
                </div>
            </form>
            <!-- lista de roles -->
            <div class="row pt-4">
                <!-- Card de Rol -->
                <div class="col-xl-4 col-lg-4 col-md-4 mb-4" th:each="rol : ${rolesPage.content}">
                    <div class="card h-100 card-hover-shadow"
                        th:style="'background-color: ' + ${rol.colorRol} + '1A; border: 1px solid ' + ${rol.colorRol} + '40; backdrop-filter: blur(10px);'">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0" th:text="${rol.nombreRol}"></h5>
                            <span class="badge text-white" th:style="'background-color: ' + ${rol.colorRol}"
                                th:text="'Nivel ' + ${rol.nivelAcceso}"></span>
                        </div>

                        <div class="card-body d-flex flex-column">
                            <p class="text-muted small mb-3 flex-grow-1" th:text="${rol.descripcionRol}"
                                style="min-height: 40px;">
                                Descripción del rol...
                            </p>
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="text-muted small">Usuarios:</span>
                                    <strong th:text="${rol.usuariosCount}">0</strong>
                                </div>
                                <span class="badge"
                                    th:classappend="${rol.estadoRol.name() == 'ACTIVO' ? 'bg-success-subtle text-success-emphasis' : 'bg-danger-subtle text-danger-emphasis'}"
                                    th:text="${rol.estadoRol.name() == 'ACTIVO' ? 'Activo' : 'Inactivo'}"></span>
                            </div>
                        </div>
                        <div class="card-footer d-flex gap-2">
                            <button class="btn btn-sm btn-outline-secondary" th:attr="data-rol-id=${rol.idRol}"
                                data-bs-toggle="modal" data-bs-target="#modalDetallePermisos"
                                sec:authorize="hasAuthority('ROLES_LEER')">
                                <i class="ti ti-key me-1"></i> Permisos (<span
                                    th:text="${rol.permisosCount}"></span>)
                            </button>
                            <button class="btn btn-sm btn-primary" th:attr="data-rol-id=${rol.idRol}"
                                data-bs-toggle="modal" data-bs-target="#modalEditarRol"
                                sec:authorize="hasAuthority('ROLES_EDITAR')">
                                <i class="ti ti-pencil me-1"></i> Editar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Mensaje si no hay roles -->
                <div class="col-12 text-center" th:if="${rolesPage.empty}">
                    <p class="text-muted">No se encontraron roles con los criterios de búsqueda.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Inclusión de Modales -->
    <div th:replace="~{sistema/roles/modal/CrearModal :: modal}"></div>
    <div th:replace="~{sistema/roles/modal/EditarModal :: modal}"></div>
    <div th:replace="~{sistema/roles/modal/DetalleModal :: modal}"></div>


    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function () {
            // Cargar contenido del modal de Edición
            const modalEditarRol = document.getElementById('modalEditarRol');
            if (modalEditarRol) {
                modalEditarRol.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const rolId = button.getAttribute('data-rol-id');
                    const modalBody = modalEditarRol.querySelector('.modal-body');
                    const url = '/seguridad/roles/editar/' + rolId;

                    fetch(url)
                        .then(response => response.text())
                        .then(html => modalBody.innerHTML = html)
                        .catch(error => console.error('Error al cargar el modal de edición:', error));
                });
            }

            // Cargar contenido del modal de Detalles
            const modalDetallePermisos = document.getElementById('modalDetallePermisos');
            if (modalDetallePermisos) {
                modalDetallePermisos.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const rolId = button.getAttribute('data-rol-id');
                    const modalBody = modalDetallePermisos.querySelector('.modal-body');
                    const url = '/seguridad/roles/detalles/' + rolId;

                    fetch(url)
                        .then(response => response.text())
                        .then(html => modalBody.innerHTML = html)
                        .catch(error => console.error('Error al cargar el modal de detalles:', error));
                });
            }
        });

        // Lógica para el modal de creación de roles
        const modalCrearRol = document.getElementById('modalCrearRol');
        if (modalCrearRol) {
            const permissionsTable = modalCrearRol.querySelector('#permissionsTable');
            const allCheckboxes = permissionsTable.querySelectorAll('.permission-checkbox');
            const selectAllSwitch = modalCrearRol.querySelector('#selectAllPermissions');
            const masterCheckboxes = permissionsTable.querySelectorAll('.master-checkbox');
            const searchInput = modalCrearRol.querySelector('#searchPermissions');
            const filterButtons = modalCrearRol.querySelectorAll('.filter-btn');
            const selectedCountSpan = modalCrearRol.querySelector('#selected-permissions-count');
            const totalCountSpan = modalCrearRol.querySelector('#total-permissions-count');

            function updateStats() {
                const visibleCheckboxes = Array.from(permissionsTable.querySelectorAll('tbody tr:not([style*="display: none"]) .permission-checkbox'));
                const checkedCount = visibleCheckboxes.filter(cb => cb.checked).length;
                selectedCountSpan.textContent = checkedCount;
                totalCountSpan.textContent = visibleCheckboxes.length;
            }

            // Seleccionar/deseleccionar todos
            selectAllSwitch.addEventListener('change', function () {
                allCheckboxes.forEach(cb => cb.checked = this.checked);
                masterCheckboxes.forEach(mcb => mcb.checked = this.checked);
                updateStats();
            });

            // Checkboxes maestros por columna (acción)
            masterCheckboxes.forEach(master => {
                master.addEventListener('change', function () {
                    const action = this.dataset.action;
                    permissionsTable.querySelectorAll(`.permission-checkbox[data-action="${action}"]`).forEach(cb => {
                        cb.checked = this.checked;
                    });
                    updateStats();
                });
            });

            allCheckboxes.forEach(cb => cb.addEventListener('change', updateStats));

            // Búsqueda
            searchInput.addEventListener('input', function () {
                const query = this.value.toLowerCase();
                permissionsTable.querySelectorAll('tbody .module-row').forEach(row => {
                    const moduleName = row.dataset.moduleName.toLowerCase();
                    row.style.display = moduleName.includes(query) ? '' : 'none';
                });
                updateStats();
            });

            // Filtros
            filterButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    filterButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const filter = this.dataset.filter;
                    permissionsTable.querySelectorAll('tbody .module-row').forEach(row => {
                        const hasChecked = row.querySelector('.permission-checkbox:checked');
                        if (filter === 'all') row.style.display = '';
                        else if (filter === 'selected') row.style.display = hasChecked ? '' : 'none';
                        else if (filter === 'unselected') row.style.display = !hasChecked ? '' : 'none';
                    });
                    updateStats();
                });
            });

            modalCrearRol.addEventListener('show.bs.modal', updateStats);
        }
    </script>
</div>

</html>