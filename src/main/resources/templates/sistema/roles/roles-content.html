<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<div th:fragment="content" id="roles-content-wrapper">
    <!-- Header de la página -->
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h1 class="mb-2 h2">Gestión de Roles</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a th:href="@{/dashboard}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="#">Seguridad</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Roles</li>
                </ol>
            </nav>
        </div>
    </div>


    <!-- Contenido principal -->
    <div class="card h-100">
        <div class="card-header d-flex justify-content-between align-items-center">
            <div>
                <h5 class="card-title mb-0">Listado de Roles</h5>
                <p class="mb-0 text-secondary small">Administra los roles y sus permisos asociados en el sistema.</p>
            </div>
            <div sec:authorize="hasAuthority('ROLES_CREAR')">
                <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalCrearRol">
                    <i class="ti ti-plus me-1"></i> Nuevo Rol
                </button>
            </div>
        </div>
        <div class="card-body">
            <!-- Formulario de Búsqueda y Filtro -->
            <form id="filterForm" th:action="@{/seguridad/roles}" method="get" class="row g-3 py-2">
                <div class="col-md-8">
                    <input type="text" class="form-control" placeholder="Buscar por nombre o nivel de acceso..."
                        th:value="${searchQuery}" name="query">
                </div>
                <div class="col-md-4">
                    <select class="form-select" id="estado" name="estado" data-choices>
                        <option value="">Todos los estados</option>
                        <option value="ACTIVO" th:selected="${estado != null and estado.name() == 'ACTIVO'}">
                            Activo
                        </option>
                        <option value="INACTIVO" th:selected="${estado != null and estado.name() == 'INACTIVO'}">
                            Inactivo
                        </option>
                    </select>
                </div>
                
                <!-- Selects de prueba -->
                <div class="col-md-4">
                    <label class="form-label">Categoría (Con búsqueda)</label>
                    <select class="form-select" data-choices-search data-search-placeholder="Buscar categoría...">
                        <option value="">Seleccionar categoría</option>
                        <option value="1">Administración</option>
                        <option value="2">Ventas</option>
                        <option value="3">Recursos Humanos</option>
                        <option value="4">Tecnología</option>
                        <option value="5">Marketing</option>
                        <option value="6">Finanzas</option>
                        <option value="7">Operaciones</option>
                        <option value="8">Legal</option>
                    </select>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Permisos (Múltiple)</label>
                    <select class="form-select" data-choices-multiple multiple data-search-placeholder="Buscar permisos...">
                        <option value="crear">Crear</option>
                        <option value="editar">Editar</option>
                        <option value="eliminar">Eliminar</option>
                        <option value="ver">Ver</option>
                        <option value="exportar">Exportar</option>
                        <option value="importar">Importar</option>
                    </select>
                </div>
                
                <div class="col-md-4">
                    <label class="form-label">Departamento (Simple)</label>
                    <select class="form-select" data-choices>
                        <option value="">Seleccionar departamento</option>
                        <option value="1">Finanzas</option>
                        <option value="2">Operaciones</option>
                        <option value="3">Legal</option>
                        <option value="4">Compras</option>
                        <option value="5">Logística</option>
                        <option value="6">Atención al Cliente</option>
                    </select>
                </div>
            </form>
            <!-- Contenedor para la lista de roles que se actualizará dinámicamente -->
            <div id="roles-list-container" class="pt-4" th:fragment="rolesList">
                <!-- lista de roles -->
                <div class="row">
                    <!-- Card de Rol -->
                    <div class="col-lg-4 col-md-6 col-12 mb-4" th:each="rol : ${rolesPage.content}">
                        <div class="card h-100 card-hover-shadow"
                            th:style="'background-color: ' + ${rol.colorRol} + '1A; border: 1px solid ' + ${rol.colorRol} + '40; backdrop-filter: blur(10px);'">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="card-title mb-0" th:text="${rol.nombreRol}"></h5>
                                <span class="badge text-white" th:style="'background-color: ' + ${rol.colorRol}"
                                    th:text="'Nivel ' + ${rol.nivelAcceso}"></span>
                            </div>

                            <div class="card-body d-flex flex-column">
                                <p class="text-muted small mb-3 flex-grow-1" th:text="${rol.descripcionRol}"
                                    style="min-height: 40px;">
                                    Descripción del rol...
                                </p>
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="text-muted small">Usuarios:</span>
                                        <strong th:text="${rol.usuariosCount}">0</strong>
                                    </div>
                                    <div class="d-flex align-items-center gap-1">
                                        <form th:action="@{/seguridad/roles/{id}/cambiar-estado(id=${rol.idRol})}"
                                            method="post" class="d-inline" sec:authorize="hasAuthority('ROLES_EDITAR')">
                                            <button type="submit"
                                                class="btn btn-sm btn-ghost-secondary rounded-circle position-relative"
                                                th:title="${rol.estadoRol.name() == 'ACTIVO' ? 'Desactivar Rol' : 'Activar Rol'}"
                                                data-bs-toggle="tooltip" data-bs-placement="top">
                                                <i class="position-absolute top-50 start-50 translate-middle"
                                                   th:classappend="${rol.estadoRol != null && rol.estadoRol.name() == 'ACTIVO' ? 'ti ti-toggle-left fs-5 text-danger' : 'ti ti-toggle-right fs-5 text-success'}"></i>
                                            </button>
                                        </form>
                                        <span class="badge"
                                            th:classappend="${rol.estadoRol != null && rol.estadoRol.name() == 'ACTIVO' ? 'bg-success-subtle text-success-emphasis' : 'bg-danger-subtle text-danger-emphasis'}"
                                            th:text="${rol.estadoRol != null && rol.estadoRol.name() == 'ACTIVO' ? 'Activo' : 'Inactivo'}"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer d-flex justify-content-between align-items-center">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-secondary" th:attr="data-rol-id=${rol.idRol}"
                                        data-bs-toggle="modal" data-bs-target="#modalDetalleRol"
                                        sec:authorize="hasAuthority('ROLES_VER')">
                                        <i class="ti ti-key me-1"></i> Permisos (<span
                                            th:text="${rol.permisosCount}"></span>)
                                    </button>
                                    <button class="btn btn-sm btn-primary" th:attr="data-rol-id=${rol.idRol}"
                                        data-bs-toggle="modal" data-bs-target="#modalEditarRol"
                                        sec:authorize="hasAuthority('ROLES_EDITAR')">
                                        <i class="ti ti-pencil me-1"></i> Editar
                                    </button>
                                </div>
                                <span data-bs-toggle="tooltip" data-bs-placement="right" title="Eliminar Rol">
                                    <button class="btn btn-sm btn-ghost-danger btn-icon"
                                        th:attr="data-rol-id=${rol.idRol}, data-rol-nombre=${rol.nombreRol}"
                                        data-bs-toggle="modal" data-bs-target="#modalEliminarRol"
                                        sec:authorize="hasAuthority('ROLES_ELIMINAR')">
                                        <i class="ti ti-trash fs-5 text-danger"></i>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- Mensaje si no hay roles -->
                    <div class="col-12 text-center" th:if="${rolesPage.empty}">
                        <p class="text-muted">No se encontraron roles con los criterios de búsqueda.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inclusión de Modales de Roles -->
    <div th:replace="~{sistema/roles/modal/CrearModal :: modalCrear}"></div>
    <div th:replace="~{sistema/roles/modal/EditarModal :: modalEditar}"></div>
    <div th:replace="~{sistema/roles/modal/DetalleModal :: modalDetalle}"></div>
    <div th:replace="~{sistema/roles/modal/EliminarModal :: modalEliminar}"></div>

    <script th:inline="javascript">
        function inicializarComponentesRoles() {
            /**
             * Inicializa la interactividad de la matriz de permisos en un modal.
             * @param {HTMLElement} modalEl - El elemento del modal.
             * @param {string} prefix - Un prefijo para los IDs de los elementos (ej. 'crear', 'editar').
             */
            function inicializarMatrizPermisos(modalEl, prefix) {
                if (!modalEl) return;

                const permissionsTable = modalEl.querySelector('.permissions-table');
                if (!permissionsTable) return;

                // Elementos de la interfaz
                const masterCheckbox = modalEl.querySelector(`#master-checkbox${prefix || ''}`);
                const allPermissionCheckboxes = permissionsTable.querySelectorAll('.permission-checkbox');
                const searchInput = modalEl.querySelector('.search-permissions');
                const filterButtons = modalEl.querySelector('.filter-buttons');
                const tableBody = permissionsTable.querySelector('tbody');

                // Contadores
                const totalModulesEl = modalEl.querySelector(`#totalModules${prefix || ''}`);
                const selectedPermissionsEl = modalEl.querySelector(`#selectedPermissions${prefix || ''}`);
                const totalPermissionsEl = modalEl.querySelector(`#totalPermissions${prefix || ''}`);

                /** --- 1. Actualización de contadores --- */
                const updateStats = () => {
                    if (!totalModulesEl || !selectedPermissionsEl || !totalPermissionsEl) return;
                    totalModulesEl.textContent = tableBody.querySelectorAll('.module-row').length;
                    selectedPermissionsEl.textContent = tableBody.querySelectorAll('.permission-checkbox:checked').length;
                    totalPermissionsEl.textContent = allPermissionCheckboxes.length;
                };

                /** --- 2. Funcionalidad "Seleccionar Todos" --- */
                if (masterCheckbox) {
                    masterCheckbox.addEventListener('change', (e) => {
                        const isChecked = e.target.checked;
                        const visibleCheckboxes = tableBody.querySelectorAll('.module-row:not([style*="display: none"]) .permission-checkbox');
                        visibleCheckboxes.forEach(checkbox => {
                            checkbox.checked = isChecked;
                        });
                        updateStats();
                    });
                }

                /** --- 3. Funcionalidad de Filtros (usando delegación de eventos) --- */
                if (filterButtons) {
                    filterButtons.addEventListener('click', (e) => {
                        const targetBtn = e.target.closest('.filter-btn');
                        if (!targetBtn) return;

                        filterButtons.querySelector('.active')?.classList.remove('active');
                        targetBtn.classList.add('active');

                        const filter = targetBtn.dataset.filter;

                        tableBody.querySelectorAll('.module-row').forEach(row => {
                            const hasChecked = row.querySelector('.permission-checkbox:checked');
                            let show = true;
                            if (filter === 'selected') show = hasChecked;
                            else if (filter === 'unselected') show = !hasChecked;
                            row.style.display = show ? '' : 'none';
                        });
                    });
                }

                /** --- 4. Búsqueda de Módulos --- */
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const query = e.target.value.toLowerCase().trim();
                        tableBody.querySelectorAll('.module-row').forEach(row => {
                            const moduleName = row.dataset.moduleName.toLowerCase();
                            row.style.display = moduleName.includes(query) ? '' : 'none';
                        });
                    });
                }

                /** --- 5. Actualizar estado al cambiar un checkbox (usando delegación de eventos) --- */
                tableBody.addEventListener('change', (e) => {
                    if (e.target.classList.contains('permission-checkbox')) {
                        updateStats();
                    }
                });

                updateStats();
            }

            const modalCrearEl = document.getElementById('modalCrearRol');
            if (modalCrearEl) {
                modalCrearEl.addEventListener('shown.bs.modal', () => inicializarMatrizPermisos(modalCrearEl, ''));
            }

            // --- Inicialización del Modal Editar ---
            const modalEditarEl = document.getElementById('modalEditarRol');
            if (modalEditarEl) {
                const editarRolContenido = document.getElementById('editar-rol-contenido');

                modalEditarEl.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const rolId = button?.getAttribute('data-rol-id');

                    if (!rolId) { return; }

                    // Mostrar spinner de carga
                    editarRolContenido.innerHTML = `<div class="d-flex justify-content-center align-items-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>`;

                    // Cargar contenido del rol
                    fetch(`/seguridad/roles/editar/${rolId}`)
                        .then(response => {
                            if (!response.ok) { throw new Error('Error al cargar los datos del rol.'); }
                            return response.text();
                        })
                        .then(html => {
                            editarRolContenido.innerHTML = html;
                            setTimeout(() => {
                                inicializarMatrizPermisos(modalEditarEl, rolId);
                            }, 100);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            editarRolContenido.innerHTML = `<div class="alert alert-danger m-3"><i class="ti ti-alert-circle me-2"></i>No se pudo cargar la información del rol.</div>`;
                        });
                });
            }

            // --- Inicialización del Modal Detalle ---
            const modalDetalleEl = document.getElementById('modalDetalleRol');
            if (modalDetalleEl) {
                const detalleRolContenido = document.getElementById('detalle-rol-contenido');

                modalDetalleEl.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const rolId = button?.getAttribute('data-rol-id');
                    const rolNombre = button?.closest('.card')?.querySelector('.card-title')?.textContent;

                    if (!rolId) { return; }

                    // Actualizar título del modal
                    const nombrePlaceholder = modalDetalleEl.querySelector('.rol-nombre-placeholder');
                    if (nombrePlaceholder && rolNombre) {
                        nombrePlaceholder.textContent = rolNombre;
                    }

                    // Mostrar spinner de carga
                    detalleRolContenido.innerHTML = `<div class="d-flex justify-content-center align-items-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>`;

                    // Cargar detalles del rol
                    fetch(`/seguridad/roles/detalles/${rolId}`)
                        .then(response => {
                            if (!response.ok) { throw new Error('Error al cargar los detalles del rol.'); }
                            return response.text();
                        })
                        .then(html => {
                            detalleRolContenido.innerHTML = html;
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            detalleRolContenido.innerHTML = `<div class="alert alert-danger m-3"><i class="ti ti-alert-circle me-2"></i>No se pudo cargar la información del rol.</div>`;
                        });
                });
            }

            // --- Inicialización del Modal Eliminar ---
            const modalEliminarEl = document.getElementById('modalEliminarRol');
            if (modalEliminarEl) {
                modalEliminarEl.addEventListener('show.bs.modal', function (event) {
                    const button = event.relatedTarget;
                    const rolId = button?.getAttribute('data-rol-id');
                    const rolNombre = button?.getAttribute('data-rol-nombre');

                    if (!rolId || !rolNombre) { return; }

                    const nombreRolEl = document.getElementById('nombreRolEliminar');
                    if (nombreRolEl) {
                        nombreRolEl.textContent = rolNombre;
                    }

                    const formEliminar = document.getElementById('formEliminarRol');
                    if (formEliminar) {
                        const action = `/seguridad/roles/delete/${rolId}`;
                        formEliminar.setAttribute('action', action);
                    }
                });
            }
        }

        // --- Lógica de Búsqueda Dinámica ---
        const filterForm = document.getElementById('filterForm'); // Ya existe
        const rolesListContainer = document.getElementById('roles-list-container');
        let debounceTimer;

        function fetchRoles() {
            const formData = new FormData(filterForm);
            const params = new URLSearchParams(formData);
            const url = `/seguridad/roles?${params.toString()}`;

            // Actualizar la URL del navegador sin recargar
            history.pushState(null, '', `/seguridad/roles?${params.toString()}`);

            // Realizar petición AJAX con header para indicar que queremos solo el fragmento
            fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With-Fragment': 'true',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor');
                    }
                    return response.text();
                })
                .then(html => {
                    if (rolesListContainer) {
                        rolesListContainer.innerHTML = html;
                        // Reinicializar tooltips de Bootstrap para los nuevos elementos
                        const tooltipTriggerList = rolesListContainer.querySelectorAll('[data-bs-toggle="tooltip"]');
                        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
                    }
                })
                .catch(error => {
                    console.error('Error al filtrar roles:', error);
                    // Mostrar mensaje de error al usuario
                    if (rolesListContainer) {
                        rolesListContainer.innerHTML = '<div class="alert alert-danger">Error al cargar los roles. Por favor, intente nuevamente.</div>';
                    }
                });
        }

        if (filterForm) {
            // Búsqueda con debounce para el input de texto
            filterForm.addEventListener('input', (e) => {
                if (e.target.name === 'query') {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(fetchRoles, 300);
                }
            });

            // Búsqueda inmediata para selects
            filterForm.addEventListener('change', (e) => {
                if (e.target.tagName === 'SELECT') {
                    fetchRoles();
                }
            });
        }

        // Ejecutar el inicializador cuando el DOM esté listo
        if (document.readyState === 'loading' && !window.rolesInitialized) {
            document.addEventListener('DOMContentLoaded', function() {
                inicializarComponentesRoles();
                window.rolesInitialized = true;
            });
        } else if (!window.rolesInitialized) {
            // El DOM ya está cargado
            inicializarComponentesRoles();
            window.rolesInitialized = true;
        }
    </script>

</div>

</html>